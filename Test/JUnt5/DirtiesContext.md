# Dirties Context Annotation

Spring 미션을 진행중에 제공된 테스트 베이스 코드에서 사용되는 어노테이션 `@DirtiesContext`에 대해서 살펴보려고 한다.

해당 어노테이션을 처음 보았기 때문에 해당 어노테이션이 어떤 기능을 하는 것인지 알아보려고 한다.

## @DirtiesContext

`@DirtiesContext`는 테스트 실행 중에 Spring `ApplicationContext`가 손상되었음을 나타냅니다. (테스트가 실행되며 테스트가 반복실행 또는 각각의 테스트가 이전의 테스트에 의해서 성공되지 않은 상태라고 생각했습니다.)

각각의 테스트가 영향을 받으며 실패하게되는 것을 막기위해서 사용되는 어노테이션이라고 생각합니다. 이는 Spring Context 컨테이너를 각각의 테스트마다 새롭게 빌드되게 합니다.

`@DirtiesContext` 어노테이션은 클래스 수준 및 메서드 수준 주석으로 모두 사용될 수 있습니다. 클래스 수준과 메서드 수준 모두에 선언된 경우 두 주석의 레벨 모두 적용이 됩니다.

'스프링 테스트에서 애플리케이션 컨텍스트는 딱 한개만 만들어지고 모든 테스트에서 공유해서 사용한다. 따라서 애플리케이션 컨텍스트 구성이나 상태를 테스트 내에서 변경하지 않는 것이 원칙이다. 만약 변경하면 나머지 모든 테스트를 수행하는 동안 변경된 애플리케이션 컨텍스트가 계속 사용될 것이다.
이럴때 @DirtiesContext 라는 어노테이션을 추가해주면 된다. 이는 스프링 테스트 컨텍스트 프레임워크에게 해당 클래스의 테스트에서 애플리케이션 컨텍스트의 상태를 변경한다는 것을 알려준다. 이 어노테이션이 붙은 곳에는 애플리케이션 컨텍스트 공유를 허용하지 않는다. 테스트 중에 변경한 컨텍스트가 뒤의 테스트에 영향을 주지 않기 위해서다 - 토비의 스프링-'

## 왜 현재 테스트 코드 주석에 @DirtiesContext를 사용하였을까?

내가 생각하기에는 해당 어노테이션을 사용하여 각각의 테스트가 서로 연관되어 결과에 영향을 주지 않게하기 위해서라고 생각이 들었다. 왜냐하면 현재 어플리케이션은 데이터를 저장하기 위해서 메모리에 저장하고 있기 때문이다. 이에 한 번 올라간 테스트 ApplicationContext의 데이터 저장소에는 테스트 코드를 실행할 때마다 데이터가 저장되고 다음 테스트에 영향을 주게된다.

그렇기에 테스트 클래스위에 각각의 메서드마다 새롭게 컨텍스트가 빌드되도록 설정을 해준것이라고 생각한다.

`@DirtiesContext(classMode = DirtiesContext.ClassMode.BEFORE_EACH_TEST_METHOD)
`

## 단점은 무엇일까?

각각의 테스트마다 ApplicationContext가 새롭게 빌드된다고 생각하면, 테스트 코드를 실행시키는데 더 오랜 시간이 걸릴것이다. 테스트 케이스가 많아질 경우를 생각해보자. 하나의 테스트 케이스를 작성할 때마다 새롭게 빌드한다.

그렇다면 이런 단점을 해결하기 위해서 어떻게 해야할까?

제일 먼저 생각나는 방법은 테스트 더블을 채택하는 것이다. 테스트 더블에는 스텁, 모킹, 페이크, 스파이가 존재한다. 이 중에 모킹을 선택하여 해당 문제점을 해결할 수 있을것 같다. (spy는 잘모름.)

## 내 JDBC 테스트 코드에 적용

이전의 미션들에 사용했던 테스트 코드를 복사해서 새로운 테스트 클래스 파일을 생성하여 테스트를 진행했었다. 위에서 @DirtiesContext 어노테이션의 문제점을 해결하기위해서 repository를 모킹해서 테스트 해볼 수 있을 것이라고 생각한다.

출처

- [Spring.io](https://docs.spring.io/spring-framework/reference/testing/annotations/integration-spring/annotation-dirtiescontext.html)
