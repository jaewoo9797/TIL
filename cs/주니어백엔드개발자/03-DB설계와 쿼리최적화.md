# 3장 성능을 좌우하는 DB 설계와 쿼리

### Summary

- [성능과 DB](#성능에-핵심인-db)
- 인덱스 설계
- 조회 성능 개선 방법
- 주의 사항

## 성능에 핵심인 DB

DB 장비의 **CPU 사용률이 높아지고 쿼리 실행 시간이 느려지는 이유 중 하나로 테이블 풀 스캔**이 있습니다.

데이터가 적을 때는 문제가 되지 않았지만 데이터 개수가 증가하며 풀 스캔으로 인해 쿼리 실행 시간이 느려지기 시작합니다.

> [!NOTE]
>
> ### Full Scan
>
> 풀스캔은 테이블의 모든 데이터를 순차적으로 읽는 것을 말한다. **보통 쿼리의 where 절에 있는 조건에 대응하는 인덱스가 없을 때 풀 스캔이 발생한다.**

인덱스를 사용하는 것보다 전체 데이터를 탐색하는 것이 더 빠를떄도 풀 스캔이 발생한다. 데이터 개수가 적을 때에는 풀 스캔을 해도 성능 문제가 겉으로 드러나지 않지만 데이터 개수가 늘어나면 어느 순간 응답 시간이 기하급수적으로 증가하게 된다.

**테이블 풀 스캔이 CPU 사용량과 실행 시간을 증가시키는 이유**
CPU가 디스크의 모든 데이터를 읽고 처리해야 하기 때문입니다. 이 과정은 I/O 작업과 데이터 처리 로직을 모두 CPU가 담당하기 떄문입니다.

데이터베이스 서버 역시 하나의 컴퓨터입니다. 디스크에 데이터를 쓰고 읽는 I/O 작업을 수행합니다. 디스크에 저장한 데이터를 읽기 위해서 I/O 버스를 통해 전달합니다.

<img src="https://img1.daumcdn.net/thumb/R1280x0/?scode=mtistory2&fname=https%3A%2F%2Fblog.kakaocdn.net%2Fdna%2Fxi6BH%2FbtsN7C3Wyet%2FAAAAAAAAAAAAAAAAAAAAAOrWgyFIbIPWKCzm0o7ztqfJXv7S3H-U6-bdZeMp6QSP%2Fimg.png%3Fcredential%3DyqXZFxpELC7KVnFOS48ylbz2pIh7yKj8%26expires%3D1756652399%26allow_ip%3D%26allow_referer%3D%26signature%3Da7AuZq2SBda8o7pOZLkbOdK3UAA%253D" alt="컴퓨터 구조" width="1000" height="auto" />

디스크는 `디스크 접근 시간`과 `시크 타임`이라는 개념이 존재합니다. 디스크 접근 시간은 데이터를 요청하고 전송 준비가 완료될 때까지의 시간을 의미합니다. 시크 타임은 디스크 암이 데이터를 읽기 위해 섹터를 찾는데 걸리는 시간입니다.

<img src="https://img1.daumcdn.net/thumb/R1280x0/?scode=mtistory2&fname=https%3A%2F%2Fblog.kakaocdn.net%2Fdna%2Fbwac3S%2FbtsN5mVP9k9%2FAAAAAAAAAAAAAAAAAAAAAPegAash8y8Q6MCSnfuY6XTrLIk4LuzJXEOrGqjx2NQr%2Fimg.png%3Fcredential%3DyqXZFxpELC7KVnFOS48ylbz2pIh7yKj8%26expires%3D1756652399%26allow_ip%3D%26allow_referer%3D%26signature%3DjkMDSdzFLupB5dodkx4lbTORfDA%253D" alt="디스크 구조" width="1000" height="auto" />

데이터를 찾기 위해서 디스크를 탐색하기 위한 방법으로 랜덤 I/O와 순차 I/O가 있습니다. 이는 데이터를 읽거나 쓰기 방식을 나타냅니다. 연속적인 순서로 접근하는 방식과 임의의 순서로 접근하는 방식입니다.

테이블 풀 스캔은 디스크에 쓰여진 데이터를 튜플 단위로 모두 읽습니다. 디스크에 쓰여진 데이터를 읽고 읽은 데이터를 I/O 버스를 통해서 CPU에게 전달해야 합니다. 이 I/O 작업과 데이터 처리 로직을 모두 CPU가 담당하게 되기 때문에 CPU 사용률이 올라가고 모든 튜플을 검사하기 때문에 응답 시간이 느려집니다.

결국 데이터베이스의 성능의 핵심은 디스크 I/O 접근을 최소화하는 것입니다. 그 방법으로 인덱스를 사용할 수 있습니다.

[테이블 풀 스캔으로 인해 실제 발생하는 문제 이슈](https://github.com/f-lab-edu/ootd-closet/issues/43)

테이블 풀 스캔으로 인해 실제 발생한 문제 이슈입니다. 대량 데이터 -> 조회 -> 풀스캔 -> DB CPU 사용률 상승 문제가 있습니다.

조회하는 패턴이 존재하기 때문에 해당 이슈는 테이블 칼럼에 인덱스를 추가해서 조회 성능을 개선하고자 합니다.

[UP](#summary)

### 단일 인덱스와 복합 인덱스

```sql
SELECT *
  FROM activityLog
 WHERE activityDate = '2024-07-31'
ORDER BY activityDateTime DESC;
```
