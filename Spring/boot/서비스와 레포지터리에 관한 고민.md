# 서비스와 레포지터리에 관한 고민

우선 해당 글에서는 넓은 범위의 고민이 함께 존재한다. 각 고민들은 서로 연관되어 있는 부분이 존재하고 
영향을 미치는 부분이 존재합니다. 이에 러프하게 제목을 잡고 하나하나 정복해보고자 한다.

- `DTO` 어느 레이어에서 변환하여 반환해야할까?
- 서비스 레이어 메서드에서 `DTO`를 리턴하는 것에대한 고찰
- 서비스 레이어에서 다른 서비스 레이어를 의존하는 것, 서비스 레이어에서 레포지터리 레이어만 의존하는 것에 대하여

<br/>

## 1. 어느것부터 생각을 정리해나가야할까
이 문서의 시작은 `DTO`과 `Domain` 의 변환을 담당하는 것이 적절한가에 대한 고민에서부터 시작했습니다.
저는 변환을 담당하는 `Converter` 객체를 만들어서 책임을 분리하여 코딩을 진행했는데, 
다른 방법에 대해서도 알게 되어 고민을 하게 되었습니다.

<br/>

제가 `converter`로 변환 했던 방법과 다른 방법으로는 `DTO` 클래스 파일 안에서 변환을 해주는 메서드를 만들어서 변환해주는 방법이 있습니다. 예를 들어
클라이언트의 요청을 도메인 객체로 변환하는 것을 코드로 살펴보겠습니다.

```java
public record ChannelCreateRequest (String name, String description) {
    
    public Channel toChannel() {
        return new Channel (this.name, this.description);
    }
}
```

<br/>

위와 같은 변환 메서드를 `DTO` 안에 배치하였습니다. 변환이 필요한 레이어에서 메서드를 호출하여 사용할 수 있는 장점이 있습니다.
제가 생각하기에 이 방식의 단점은 `DTO`가 `Domain`에 의존하게 되며 강하게 결합되어 도메인의 변경에 따라 영향을 직접적으로
받게 됩니다. 그리고 채널 객체를 생성하는 비즈니스 로직이 복잡해질 경우에는 안에서 처리하는 것이 복잡해질 수 있다.

예를 들어, 하나의 채널을 생성하는데 유저의 정보와 채널별로 카테고리가 존재하여 카테고리의 정보도 포함되어야 한다고
가정해보겠습니다.

> 채널에서 유저와 카테고리의 id 만을 저장하는 것이 아닌 객체를 저장한다고 가정하겠습니다. (객체지향)

<br/>

*채널 객체*를 생성하기 전에 해당 *유저 객체*와 *카테고리 객체*를 조회해와서 저희가 저장하려는 채널 객체를 
생성해야합니다. 데이터 정합성을 위해서 request로 받은 유저와 카테고리 정보를 이용해서 
데이터베이스에서 조회해 객체를 생성해야 한다고 생각하기에 `DTO` 내부에서 변환하는 것에는 적합하지 않다고 생각합니다. 
만약 DTO 내부에서 repository를 의존해서 내부에서 처리한다고 하면 데이터 전송을 위한 DTO 객체의 책임이 과해지고 
의존해야하는 방향이 적합하지 않다고 생각합니다. 

또한 클라이언트의 요청을 받아 request 객체로 매핑하는 컨트롤러 또한 적합하지 않다고 생각합니다. 컨트롤러는 클라이언트와 서버
사이에서 요청과 응답을 수행하는 역할이라고 생각하기 때문입니다. 이에 컨트롤러는 서비스 레이어에 위임하여 비즈니스 로직을
수행해야 합니다.

<br/>

```java
public record ChannelCreateRequest(Long userId, Long categoryId, String name, String description) {
}

@Service
public class ChannelService {
    
    //.. 레포지터리, 생성자 등등..
    
    public Channel createChannel(ChannelCreateRequest request) {
        User user = userRepository.findById(request.userId());
        Category category = categoryRepository.findById(request.categoryId());
        Channel channel = new Channel(request.name(), request.description(), user, category);
        channelRepository.save(channel);
    }
}
```

<br/>

### `DTO` ➡️ `Domain` 
제가 생각하는 `DTO` -> `Domain` 으로의 변환은 `서비스 레이어에서 담당해야 한다` 입니다.
이러한 저의 의견에 이렇게 반대할 수도 있다고 생각합니다. 간단한 객체 생성의 클라이언트의 요청에는 `DTO` 내부에 필요한
모든 데이터를 받아서 객체를 생성할 수도 있지 않을까? 

저는 두 가지의 이유로 간단한 객체의 생성일지라도 `DTO` 내부에서 변환을 하는 것을 반대합니다.
1. `DTO` 객체가 도메인 객체를 의존하여 결합을 발생시킬 이유가 있는가?
2. 어느 `DTO` 는 내부적으로 변환을 하고, 일부 `DTO`는 서비스 레이어에서 변환을 하는 일관성이 없는 코딩

**첫 번째**로 두 객체 사이에 발생하는 결합을 생각하면 도메인의 변경에 영향을 강하게 받는 `DTO`를 만들게 되고, 데이터를 전달
하는 역할인 `DTO`가 도메인을 알게되며 도메인을 의존하는 새로운 관계가 생긴다. `service` -> `domain` <- `DTO`

**두 번째**로는 일관성이 없어진다. 프로그래밍을 하는 것은 혼자만이 하는 것이 아닌, 옆의 동료와 함께 만들어가는 과정이다.
일관성이 없다면 협업간에 무분별한 코드가 생성되고 혼란을 불러오며, 불필요한 리소스를 소비하게 된다고 생각한다. 이에
모두 같은 방식으로 적절한 선택을 통해 일관성 있는 작업을 해야한다고 생각한다. 물론 `DTO` 내부에서 변환하는 것이 더 
적합하다고 동료간의 타협이 이루어지면 유연하게 작업해야하는 부분이기도 하다.

<br/>


## `Domain` -> `DTO`
앞서 `DTO`에서 `Domain` 으로 변환하는 과정에 대한 생각을 정리하였습니다. 이번에는 반대로 가공된 데이터를 클라이언트에게
반환해주는 방법에 대해서 생각해보겠습니다.

이번에는 여러 방면을 고려하여 결정을 해야한다고 생각했습니다. 먼저 `DTO`가 도메인 객체를 파라미터로 받아 변환하는 방식을 
코드로 살펴보겠습니다.

```java

```

